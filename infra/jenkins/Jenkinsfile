stage('dev') {
    node{
        checkout scm

        openshift.withProject( "todo-app-dev" ) {
            def buildTemplate = openshift.process("-f infra/yml/s2i-todo-app-build-template.yml")
            openshift.apply(buildTemplate)

            openshift.startBuild("todo-app", "--wait=true")

            def deploymentTemplate = openshift.process("-f infra/yml/todo-app-deployment-template.yml")
            openshift.apply(deploymentTemplate)

            openshift.selector("dc/todo-app").rollout().latest()
            openshift.selector("dc/todo-app").rollout().status("--watch=true")

            openshift.tag("todo-app-dev/todo-app:latest todo-app-int/todo-app:latest")
        }
    }
}

stage('int') {
    node{

        openshift.withProject( "todo-app-int" ) {
            def deploymentTemplate = openshift.process("-f infra/yml/todo-app-deployment-template.yml")
            openshift.apply(deploymentTemplate)

            openshift.selector("dc/todo-app").rollout().latest()
            openshift.selector("dc/todo-app").rollout().status("--watch=true")

            openshift.tag("todo-app-int/todo-app:latest todo-app-prod/todo-app:latest")
        }
    }
}

stage('prod') {
    node{
        openshift.withProject( "todo-app-prod" ) {
            def deploymentTemplate = openshift.process("-f infra/yml/todo-app-deployment-template.yml")
            openshift.apply(deploymentTemplate)

            openshift.selector("dc/todo-app").rollout().latest()
            openshift.selector("dc/todo-app").rollout().status("--watch=true")
        }
    }
}

